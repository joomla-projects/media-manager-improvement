!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e):e(CodeMirror)}(function(e){"use strict";function n(n,t,r){if(r<0&&0==t.ch)return n.clipPos(p(t.line-1));var o=n.getLine(t.line);if(r>0&&t.ch>=o.length)return n.clipPos(p(t.line+1,0));for(var i,a="start",l=t.ch,s=r<0?0:o.length,c=0;l!=s;l+=r,c++){var f=o.charAt(r<0?l-1:l),u="_"!=f&&e.isWordChar(f)?"w":"o";if("w"==u&&f.toUpperCase()==f&&(u="W"),"start"==a)"o"!=u&&(a="in",i=u);else if("in"==a&&i!=u){if("w"==i&&"W"==u&&r<0&&l--,"W"==i&&"w"==u&&r>0){i="w";continue}break}}return p(t.line,l)}function t(e,t){e.extendSelectionsBy(function(r){return e.display.shift||e.doc.extend||r.empty()?n(e.doc,r.head,t):t<0?r.from():r.to()})}function r(n,t){if(n.isReadOnly())return e.Pass;n.operation(function(){for(var e=n.listSelections().length,r=[],o=-1,i=0;i<e;i++){var a=n.listSelections()[i].head;if(!(a.line<=o)){var l=p(a.line+(t?0:1),0);n.replaceRange("\n",l,null,"+insertLine"),n.indentLine(l.line,null,!0),r.push({head:l,anchor:l}),o=a.line+1}}n.setSelections(r)}),n.execCommand("indentAuto")}function o(n,t){for(var r=t.ch,o=r,i=n.getLine(t.line);r&&e.isWordChar(i.charAt(r-1));)--r;for(;o<i.length&&e.isWordChar(i.charAt(o));)++o;return{from:p(t.line,r),to:p(t.line,o),word:i.slice(r,o)}}function i(e,n){for(var t=e.listSelections(),r=[],o=0;o<t.length;o++){var i=t[o],a={anchor:e.findPosV(i.anchor,n,"line"),head:e.findPosV(i.head,n,"line")};r.push(i),r.push(a)}e.setSelections(r)}function a(e,n,t){for(var r=0;r<e.length;r++)if(e[r].from()==n&&e[r].to()==t)return!0;return!1}function l(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++){var o=n[r].head,i=e.scanForBracket(o,-1);if(!i)return!1;for(;;){var a=e.scanForBracket(o,1);if(!a)return!1;if(a.ch==L.charAt(L.indexOf(i.ch)+1)){t.push({anchor:p(i.pos.line,i.pos.ch+1),head:a.pos});break}o=p(a.pos.line,a.pos.ch+1)}}return e.setSelections(t),!0}function s(n,t){if(n.isReadOnly())return e.Pass;for(var r,o=n.listSelections(),i=[],a=0;a<o.length;a++){var l=o[a];if(!l.empty()){for(var s=l.from().line,c=l.to().line;a<o.length-1&&o[a+1].from().line==c;)c=o[++a].to().line;o[a].to().ch||c--,i.push(s,c)}}i.length?r=!0:i.push(n.firstLine(),n.lastLine()),n.operation(function(){for(var e=[],o=0;o<i.length;o+=2){var a=i[o],l=i[o+1],s=p(a,0),c=p(l),f=n.getRange(s,c,!1);t?f.sort():f.sort(function(e,n){var t=e.toUpperCase(),r=n.toUpperCase();return t!=r&&(e=t,n=r),e<n?-1:e==n?0:1}),n.replaceRange(f,s,c),r&&e.push({anchor:s,head:p(l+1,0)})}r&&n.setSelections(e,0)})}function c(n,t){n.operation(function(){for(var r=n.listSelections(),i=[],a=[],l=0;l<r.length;l++)(c=r[l]).empty()?(i.push(l),a.push("")):a.push(t(n.getRange(c.from(),c.to())));n.replaceSelections(a,"around","case");for(var s,l=i.length-1;l>=0;l--){var c=r[i[l]];if(!(s&&e.cmpPos(c.head,s)>0)){var f=o(n,c.head);s=f.from,n.replaceRange(t(f.word),f.from,f.to)}}})}function f(n){var t=n.getCursor("from"),r=n.getCursor("to");if(0==e.cmpPos(t,r)){var i=o(n,t);if(!i.word)return;t=i.from,r=i.to}return{from:t,to:r,query:n.getRange(t,r),word:i}}function u(e,n){var t=f(e);if(t){var r=t.query,o=e.getSearchCursor(r,n?t.to:t.from);(n?o.findNext():o.findPrevious())?e.setSelection(o.from(),o.to()):(o=e.getSearchCursor(r,n?p(e.firstLine(),0):e.clipPos(p(e.lastLine()))),(n?o.findNext():o.findPrevious())?e.setSelection(o.from(),o.to()):t.word&&e.setSelection(t.from,t.to))}}var h=e.keyMap.sublime={fallthrough:"default"},d=e.commands,p=e.Pos,m=e.keyMap.default==e.keyMap.macDefault,g=m?"Cmd-":"Ctrl-",v=m?"Ctrl-":"Alt-";d[h[v+"Left"]="goSubwordLeft"]=function(e){t(e,-1)},d[h[v+"Right"]="goSubwordRight"]=function(e){t(e,1)},m&&(h["Cmd-Left"]="goLineStartSmart");var S=m?"Ctrl-Alt-":"Ctrl-";d[h[S+"Up"]="scrollLineUp"]=function(e){var n=e.getScrollInfo();if(!e.somethingSelected()){var t=e.lineAtHeight(n.top+n.clientHeight,"local");e.getCursor().line>=t&&e.execCommand("goLineUp")}e.scrollTo(null,n.top-e.defaultTextHeight())},d[h[S+"Down"]="scrollLineDown"]=function(e){var n=e.getScrollInfo();if(!e.somethingSelected()){var t=e.lineAtHeight(n.top,"local")+1;e.getCursor().line<=t&&e.execCommand("goLineDown")}e.scrollTo(null,n.top+e.defaultTextHeight())},d[h["Shift-"+g+"L"]="splitSelectionByLine"]=function(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++)for(var o=n[r].from(),i=n[r].to(),a=o.line;a<=i.line;++a)i.line>o.line&&a==i.line&&0==i.ch||t.push({anchor:a==o.line?o:p(a,0),head:a==i.line?i:p(a)});e.setSelections(t,0)},h["Shift-Tab"]="indentLess",d[h.Esc="singleSelectionTop"]=function(e){var n=e.listSelections()[0];e.setSelection(n.anchor,n.head,{scroll:!1})},d[h[g+"L"]="selectLine"]=function(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++){var o=n[r];t.push({anchor:p(o.from().line,0),head:p(o.to().line+1,0)})}e.setSelections(t)},h["Shift-Ctrl-K"]="deleteLine",d[h[g+"Enter"]="insertLineAfter"]=function(e){return r(e,!1)},d[h["Shift-"+g+"Enter"]="insertLineBefore"]=function(e){return r(e,!0)},d[h[g+"D"]="selectNextOccurrence"]=function(n){var t=n.getCursor("from"),r=n.getCursor("to"),i=n.state.sublimeFindFullWord==n.doc.sel;if(0==e.cmpPos(t,r)){var l=o(n,t);if(!l.word)return;n.setSelection(l.from,l.to),i=!0}else{var s=n.getRange(t,r),c=i?new RegExp("\\b"+s+"\\b"):s,f=n.getSearchCursor(c,r),u=f.findNext();if(u||(u=(f=n.getSearchCursor(c,p(n.firstLine(),0))).findNext()),!u||a(n.listSelections(),f.from(),f.to()))return e.Pass;n.addSelection(f.from(),f.to())}i&&(n.state.sublimeFindFullWord=n.doc.sel)};var k=m?"Shift-Cmd":"Alt-Ctrl";d[h[k+"Up"]="addCursorToPrevLine"]=function(e){i(e,-1)},d[h[k+"Down"]="addCursorToNextLine"]=function(e){i(e,1)};var L="(){}[]";d[h["Shift-"+g+"Space"]="selectScope"]=function(e){l(e)||e.execCommand("selectAll")},d[h["Shift-"+g+"M"]="selectBetweenBrackets"]=function(n){if(!l(n))return e.Pass},d[h[g+"M"]="goToBracket"]=function(n){n.extendSelectionsBy(function(t){var r=n.scanForBracket(t.head,1);if(r&&0!=e.cmpPos(r.pos,t.head))return r.pos;var o=n.scanForBracket(t.head,-1);return o&&p(o.pos.line,o.pos.ch+1)||t.head})};var C=m?"Cmd-Ctrl-":"Shift-Ctrl-";d[h[C+"Up"]="swapLineUp"]=function(n){if(n.isReadOnly())return e.Pass;for(var t=n.listSelections(),r=[],o=n.firstLine()-1,i=[],a=0;a<t.length;a++){var l=t[a],s=l.from().line-1,c=l.to().line;i.push({anchor:p(l.anchor.line-1,l.anchor.ch),head:p(l.head.line-1,l.head.ch)}),0!=l.to().ch||l.empty()||--c,s>o?r.push(s,c):r.length&&(r[r.length-1]=c),o=c}n.operation(function(){for(var e=0;e<r.length;e+=2){var t=r[e],o=r[e+1],a=n.getLine(t);n.replaceRange("",p(t,0),p(t+1,0),"+swapLine"),o>n.lastLine()?n.replaceRange("\n"+a,p(n.lastLine()),null,"+swapLine"):n.replaceRange(a+"\n",p(o,0),null,"+swapLine")}n.setSelections(i),n.scrollIntoView()})},d[h[C+"Down"]="swapLineDown"]=function(n){if(n.isReadOnly())return e.Pass;for(var t=n.listSelections(),r=[],o=n.lastLine()+1,i=t.length-1;i>=0;i--){var a=t[i],l=a.to().line+1,s=a.from().line;0!=a.to().ch||a.empty()||l--,l<o?r.push(l,s):r.length&&(r[r.length-1]=s),o=s}n.operation(function(){for(var e=r.length-2;e>=0;e-=2){var t=r[e],o=r[e+1],i=n.getLine(t);t==n.lastLine()?n.replaceRange("",p(t-1),p(t),"+swapLine"):n.replaceRange("",p(t,0),p(t+1,0),"+swapLine"),n.replaceRange(i+"\n",p(o,0),null,"+swapLine")}n.scrollIntoView()})},d[h[g+"/"]="toggleCommentIndented"]=function(e){e.toggleComment({indent:!0})},d[h[g+"J"]="joinLines"]=function(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++){for(var o=n[r],i=o.from(),a=i.line,l=o.to().line;r<n.length-1&&n[r+1].from().line==l;)l=n[++r].to().line;t.push({start:a,end:l,anchor:!o.empty()&&i})}e.operation(function(){for(var n=0,r=[],o=0;o<t.length;o++){for(var i,a=t[o],l=a.anchor&&p(a.anchor.line-n,a.anchor.ch),s=a.start;s<=a.end;s++){var c=s-n;s==a.end&&(i=p(c,e.getLine(c).length+1)),c<e.lastLine()&&(e.replaceRange(" ",p(c),p(c+1,/^\s*/.exec(e.getLine(c+1))[0].length)),++n)}r.push({anchor:l||i,head:i})}e.setSelections(r,0)})},d[h["Shift-"+g+"D"]="duplicateLine"]=function(e){e.operation(function(){for(var n=e.listSelections().length,t=0;t<n;t++){var r=e.listSelections()[t];r.empty()?e.replaceRange(e.getLine(r.head.line)+"\n",p(r.head.line,0)):e.replaceRange(e.getRange(r.from(),r.to()),r.from())}e.scrollIntoView()})},m||(h[g+"T"]="transposeChars"),d[h.F9="sortLines"]=function(e){s(e,!0)},d[h[g+"F9"]="sortLinesInsensitive"]=function(e){s(e,!1)},d[h.F2="nextBookmark"]=function(e){var n=e.state.sublimeBookmarks;if(n)for(;n.length;){var t=n.shift(),r=t.find();if(r)return n.push(t),e.setSelection(r.from,r.to)}},d[h["Shift-F2"]="prevBookmark"]=function(e){var n=e.state.sublimeBookmarks;if(n)for(;n.length;){n.unshift(n.pop());var t=n[n.length-1].find();if(t)return e.setSelection(t.from,t.to);n.pop()}},d[h[g+"F2"]="toggleBookmark"]=function(e){for(var n=e.listSelections(),t=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]),r=0;r<n.length;r++){for(var o=n[r].from(),i=n[r].to(),a=e.findMarks(o,i),l=0;l<a.length;l++)if(a[l].sublimeBookmark){a[l].clear();for(var s=0;s<t.length;s++)t[s]==a[l]&&t.splice(s--,1);break}l==a.length&&t.push(e.markText(o,i,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},d[h["Shift-"+g+"F2"]="clearBookmarks"]=function(e){var n=e.state.sublimeBookmarks;if(n)for(var t=0;t<n.length;t++)n[t].clear();n.length=0},d[h["Alt-F2"]="selectBookmarks"]=function(e){var n=e.state.sublimeBookmarks,t=[];if(n)for(var r=0;r<n.length;r++){var o=n[r].find();o?t.push({anchor:o.from,head:o.to}):n.splice(r--,0)}t.length&&e.setSelections(t,0)},h["Alt-Q"]="wrapLines";var b=g+"K ";h[b+g+"Backspace"]="delLineLeft",d[h.Backspace="smartBackspace"]=function(n){if(n.somethingSelected())return e.Pass;n.operation(function(){for(var t=n.listSelections(),r=n.getOption("indentUnit"),o=t.length-1;o>=0;o--){var i=t[o].head,a=n.getRange({line:i.line,ch:0},i),l=e.countColumn(a,null,n.getOption("tabSize")),s=n.findPosH(i,-1,"char",!1);if(a&&!/\S/.test(a)&&l%r==0){var c=new p(i.line,e.findColumn(a,l-r,r));c.ch!=i.ch&&(s=c)}n.replaceRange("",s,i,"+delete")}})},d[h[b+g+"K"]="delLineRight"]=function(e){e.operation(function(){for(var n=e.listSelections(),t=n.length-1;t>=0;t--)e.replaceRange("",n[t].anchor,p(n[t].to().line),"+delete");e.scrollIntoView()})},d[h[b+g+"U"]="upcaseAtCursor"]=function(e){c(e,function(e){return e.toUpperCase()})},d[h[b+g+"L"]="downcaseAtCursor"]=function(e){c(e,function(e){return e.toLowerCase()})},d[h[b+g+"Space"]="setSublimeMark"]=function(e){e.state.sublimeMark&&e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor())},d[h[b+g+"A"]="selectToSublimeMark"]=function(e){var n=e.state.sublimeMark&&e.state.sublimeMark.find();n&&e.setSelection(e.getCursor(),n)},d[h[b+g+"W"]="deleteToSublimeMark"]=function(n){var t=n.state.sublimeMark&&n.state.sublimeMark.find();if(t){var r=n.getCursor(),o=t;if(e.cmpPos(r,o)>0){var i=o;o=r,r=i}n.state.sublimeKilled=n.getRange(r,o),n.replaceRange("",r,o)}},d[h[b+g+"X"]="swapWithSublimeMark"]=function(e){var n=e.state.sublimeMark&&e.state.sublimeMark.find();n&&(e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor()),e.setCursor(n))},d[h[b+g+"Y"]="sublimeYank"]=function(e){null!=e.state.sublimeKilled&&e.replaceSelection(e.state.sublimeKilled,null,"paste")},h[b+g+"G"]="clearBookmarks",d[h[b+g+"C"]="showInCenter"]=function(e){var n=e.cursorCoords(null,"local");e.scrollTo(null,(n.top+n.bottom)/2-e.getScrollInfo().clientHeight/2)};var w=m?"Ctrl-Shift-":"Ctrl-Alt-";d[h[w+"Up"]="selectLinesUpward"]=function(e){e.operation(function(){for(var n=e.listSelections(),t=0;t<n.length;t++){var r=n[t];r.head.line>e.firstLine()&&e.addSelection(p(r.head.line-1,r.head.ch))}})},d[h[w+"Down"]="selectLinesDownward"]=function(e){e.operation(function(){for(var n=e.listSelections(),t=0;t<n.length;t++){var r=n[t];r.head.line<e.lastLine()&&e.addSelection(p(r.head.line+1,r.head.ch))}})},d[h[g+"F3"]="findUnder"]=function(e){u(e,!0)},d[h["Shift-"+g+"F3"]="findUnderPrevious"]=function(e){u(e,!1)},d[h["Alt-F3"]="findAllUnder"]=function(e){var n=f(e);if(n){for(var t=e.getSearchCursor(n.query),r=[],o=-1;t.findNext();)r.push({anchor:t.from(),head:t.to()}),t.from().line<=n.from.line&&t.from().ch<=n.from.ch&&o++;e.setSelections(r,o)}},h["Shift-"+g+"["]="fold",h["Shift-"+g+"]"]="unfold",h[b+g+"0"]=h[b+g+"J"]="unfoldAll",h[g+"I"]="findIncremental",h["Shift-"+g+"I"]="findIncrementalReverse",h[g+"H"]="replace",h.F3="findNext",h["Shift-F3"]="findPrev",e.normalizeKeyMap(h)});