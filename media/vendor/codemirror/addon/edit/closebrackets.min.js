!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){function t(e,t){return"pairs"==t&&"string"==typeof e?e:"object"==typeof e&&null!=e[t]?e[t]:h[t]}function n(e){for(var t=0;t<e.length;t++){var n=e.charAt(t),i="'"+n+"'";d[i]||(d[i]=r(n))}}function r(e){return function(t){return o(t,e)}}function i(e){var t=e.state.closeBrackets;return!t||t.override?t:e.getModeAt(e.getCursor()).closeBrackets||t}function a(t){var n=e.cmpPos(t.anchor,t.head)>0;return{anchor:new u(t.anchor.line,t.anchor.ch+(n?-1:1)),head:new u(t.head.line,t.head.ch+(n?1:-1))}}function o(n,r){var o=i(n);if(!o||n.getOption("disableInput"))return e.Pass;var c=t(o,"pairs"),h=c.indexOf(r);if(-1==h)return e.Pass;for(var d,g=t(o,"triples"),p=c.charAt(h+1)==r,v=n.listSelections(),m=h%2==0,b=0;b<v.length;b++){var x,C=v[b],k=C.head,P=n.getRange(k,u(k.line,k.ch+1));if(m&&!C.empty())x="surround";else if(!p&&m||P!=r)if(p&&k.ch>1&&g.indexOf(r)>=0&&n.getRange(u(k.line,k.ch-2),k)==r+r&&(k.ch<=2||n.getRange(u(k.line,k.ch-3),u(k.line,k.ch-2))!=r))x="addFour";else if(p){if(e.isWordChar(P)||!l(n,k,r))return e.Pass;x="both"}else{if(!m||n.getLine(k.line).length!=k.ch&&!s(P,c)&&!/\s/.test(P))return e.Pass;x="both"}else x=p&&f(n,k)?"both":g.indexOf(r)>=0&&n.getRange(k,u(k.line,k.ch+3))==r+r+r?"skipThree":"skip";if(d){if(d!=x)return e.Pass}else d=x}var S=h%2?c.charAt(h-1):r,y=h%2?r:c.charAt(h+1);n.operation(function(){if("skip"==d)n.execCommand("goCharRight");else if("skipThree"==d)for(t=0;t<3;t++)n.execCommand("goCharRight");else if("surround"==d){for(var e=n.getSelections(),t=0;t<e.length;t++)e[t]=S+e[t]+y;n.replaceSelections(e,"around"),e=n.listSelections().slice();for(t=0;t<e.length;t++)e[t]=a(e[t]);n.setSelections(e)}else"both"==d?(n.replaceSelection(S+y,null),n.triggerElectric(S+y),n.execCommand("goCharLeft")):"addFour"==d&&(n.replaceSelection(S+S+S+S,"before"),n.execCommand("goCharRight"))})}function s(e,t){var n=t.lastIndexOf(e);return n>-1&&n%2==1}function c(e,t){var n=e.getRange(u(t.line,t.ch-1),u(t.line,t.ch+1));return 2==n.length?n:null}function l(t,n,r){var i=t.getLine(n.line),a=t.getTokenAt(n);if(/\bstring2?\b/.test(a.type)||f(t,n))return!1;var o=new e.StringStream(i.slice(0,n.ch)+r+i.slice(n.ch),4);for(o.pos=o.start=a.start;;){var s=t.getMode().token(o,a.state);if(o.pos>=n.ch+1)return/\bstring2?\b/.test(s);o.start=o.pos}}function f(e,t){var n=e.getTokenAt(u(t.line,t.ch+1));return/\bstring/.test(n.type)&&n.start==t.ch}var h={pairs:"()[]{}''\"\"",triples:"",explode:"[]{}"},u=e.Pos;e.defineOption("autoCloseBrackets",!1,function(r,i,a){a&&a!=e.Init&&(r.removeKeyMap(d),r.state.closeBrackets=null),i&&(n(t(i,"pairs")),r.state.closeBrackets=i,r.addKeyMap(d))});var d={Backspace:function(n){var r=i(n);if(!r||n.getOption("disableInput"))return e.Pass;for(var a=t(r,"pairs"),o=n.listSelections(),s=0;s<o.length;s++){if(!o[s].empty())return e.Pass;var l=c(n,o[s].head);if(!l||a.indexOf(l)%2!=0)return e.Pass}for(s=o.length-1;s>=0;s--){var f=o[s].head;n.replaceRange("",u(f.line,f.ch-1),u(f.line,f.ch+1),"+delete")}},Enter:function(n){var r=i(n),a=r&&t(r,"explode");if(!a||n.getOption("disableInput"))return e.Pass;for(var o=n.listSelections(),s=0;s<o.length;s++){if(!o[s].empty())return e.Pass;var l=c(n,o[s].head);if(!l||a.indexOf(l)%2!=0)return e.Pass}n.operation(function(){n.replaceSelection("\n\n",null),n.execCommand("goCharLeft"),o=n.listSelections();for(var e=0;e<o.length;e++){var t=o[e].head.line;n.indentLine(t,null,!0),n.indentLine(t+1,null,!0)}})}};n(h.pairs+"`")});