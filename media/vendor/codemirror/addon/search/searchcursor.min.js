!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(t){"use strict";var e=t.Pos;function n(t){return t.global?t:new RegExp(t.source,function(t){var e=t.flags;return null!=e?e:(t.ignoreCase?"i":"")+(t.global?"g":"")+(t.multiline?"m":"")}(t)+"g")}function r(t,r,i){r=n(r);for(var o=i.line,l=i.ch,h=t.lastLine();o<=h;o++,l=0){r.lastIndex=l;var s=t.getLine(o),c=r.exec(s);if(c)return{from:e(o,c.index),to:e(o,c.index+c[0].length),match:c}}}function i(t,e){for(var n,r=0;;){e.lastIndex=r;var i=e.exec(t);if(!i)return n;if((r=(n=i).index+(n[0].length||1))==t.length)return n}}var o,l;String.prototype.normalize?(o=function(t){return t.normalize("NFD").toLowerCase()},l=function(t){return t.normalize("NFD")}):(o=function(t){return t.toLowerCase()},l=function(t){return t});function h(t,e,n,r){if(t.length==e.length)return n;for(var i=0,o=n+Math.max(0,t.length-e.length);;){if(i==o)return i;var l=i+o>>1,h=r(t.slice(0,l)).length;if(h==n)return l;h>n?o=l:i=l+1}}function s(t,s,c,f){this.atOccurrence=!1,this.doc=t,c=c?t.clipPos(c):e(0,0),this.pos={from:c,to:c};var u;"object"==typeof f?u=f.caseFold:(u=f,f=null),"string"==typeof s?(null==u&&(u=!1),this.matches=function(n,r){return(n?function(t,n,r,i){if(!n.length)return null;var s=i?o:l,c=s(n).split(/\r|\n\r?/);t:for(var f=r.line,u=r.ch,a=t.firstLine()-1+c.length;f>=a;f--,u=-1){var g=t.getLine(f);u>-1&&(g=g.slice(0,u));var m=s(g);if(1==c.length){var v=m.lastIndexOf(c[0]);if(-1==v)continue t;return{from:e(f,h(g,m,v,s)),to:e(f,h(g,m,v+c[0].length,s))}}var d=c[c.length-1];if(m.slice(0,d.length)==d){var p=1;for(r=f-c.length+1;p<c.length-1;p++)if(s(t.getLine(r+p))!=c[p])continue t;var L=t.getLine(f+1-c.length),x=s(L);if(x.slice(x.length-c[0].length)==c[0])return{from:e(f+1-c.length,h(L,x,L.length-c[0].length,s)),to:e(f,h(g,m,d.length,s))}}}}:function(t,n,r,i){if(!n.length)return null;var s=i?o:l,c=s(n).split(/\r|\n\r?/);t:for(var f=r.line,u=r.ch,a=t.lastLine()+1-c.length;f<=a;f++,u=0){var g=t.getLine(f).slice(u),m=s(g);if(1==c.length){var v=m.indexOf(c[0]);if(-1==v)continue t;return r=h(g,m,v,s)+u,{from:e(f,h(g,m,v,s)+u),to:e(f,h(g,m,v+c[0].length,s)+u)}}var d=m.length-c[0].length;if(m.slice(d)==c[0]){for(var p=1;p<c.length-1;p++)if(s(t.getLine(f+p))!=c[p])continue t;var L=t.getLine(f+c.length-1),x=s(L),C=c[c.length-1];if(x.slice(0,C.length)==C)return{from:e(f,h(g,m,d,s)+u),to:e(f+c.length-1,h(L,x,C.length,s))}}}})(t,s,r,u)}):(s=n(s),f&&!1===f.multiline?this.matches=function(o,l){return(o?function(t,r,o){r=n(r);for(var l=o.line,h=o.ch,s=t.firstLine();l>=s;l--,h=-1){var c=t.getLine(l);h>-1&&(c=c.slice(0,h));var f=i(c,r);if(f)return{from:e(l,f.index),to:e(l,f.index+f[0].length),match:f}}}:r)(t,s,l)}:this.matches=function(o,l){return(o?function(t,r,o){r=n(r);for(var l,h=1,s=o.line,c=t.firstLine();s>=c;){for(var f=0;f<h;f++){var u=t.getLine(s--);l=null==l?u.slice(0,o.ch):u+"\n"+l}h*=2;var a=i(l,r);if(a){var g=l.slice(0,a.index).split("\n"),m=a[0].split("\n"),v=s+g.length,d=g[g.length-1].length;return{from:e(v,d),to:e(v+m.length-1,1==m.length?d+m[0].length:m[m.length-1].length),match:a}}}}:function(t,i,o){if(!/\\s|\\n|\n|\\W|\\D|\[\^/.test(i.source))return r(t,i,o);i=n(i);for(var l,h=1,s=o.line,c=t.lastLine();s<=c;){for(var f=0;f<h;f++){var u=t.getLine(s++);l=null==l?u:l+"\n"+u}h*=2,i.lastIndex=o.ch;var a=i.exec(l);if(a){var g=l.slice(0,a.index).split("\n"),m=a[0].split("\n"),v=o.line+g.length-1,d=g[g.length-1].length;return{from:e(v,d),to:e(v+m.length-1,1==m.length?d+m[0].length:m[m.length-1].length),match:a}}}})(t,s,l)})}s.prototype={findNext:function(){return this.find(!1)},findPrevious:function(){return this.find(!0)},find:function(n){for(var r=this.matches(n,this.doc.clipPos(n?this.pos.from:this.pos.to));r&&0==t.cmpPos(r.from,r.to);)n?r.from.ch?r.from=e(r.from.line,r.from.ch-1):r=r.from.line==this.doc.firstLine()?null:this.matches(n,this.doc.clipPos(e(r.from.line-1))):r.to.ch<this.doc.getLine(r.to.line).length?r.to=e(r.to.line,r.to.ch+1):r=r.to.line==this.doc.lastLine()?null:this.matches(n,e(r.to.line+1,0));if(r)return this.pos=r,this.atOccurrence=!0,this.pos.match||!0;var i=e(n?this.doc.firstLine():this.doc.lastLine()+1,0);return this.pos={from:i,to:i},this.atOccurrence=!1},from:function(){if(this.atOccurrence)return this.pos.from},to:function(){if(this.atOccurrence)return this.pos.to},replace:function(n,r){if(this.atOccurrence){var i=t.splitLines(n);this.doc.replaceRange(i,this.pos.from,this.pos.to,r),this.pos.to=e(this.pos.from.line+i.length-1,i[i.length-1].length+(1==i.length?this.pos.from.ch:0))}}},t.defineExtension("getSearchCursor",function(t,e,n){return new s(this.doc,t,e,n)}),t.defineDocExtension("getSearchCursor",function(t,e,n){return new s(this,t,e,n)}),t.defineExtension("selectMatches",function(e,n){for(var r=[],i=this.getSearchCursor(e,this.getCursor("from"),n);i.findNext()&&!(t.cmpPos(i.to(),this.getCursor("to"))>0);)r.push({anchor:i.from(),head:i.to()});r.length&&this.setSelections(r,0)})});