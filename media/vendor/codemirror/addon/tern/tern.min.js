!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n){var o=e.docs[t];o?n(x(e,o)):e.options.getFile?e.options.getFile(t,n):n(null)}function n(e,t,n){for(var o in e.docs){var i=e.docs[o];if(i.doc==t)return i}if(!n)for(var r=0;;++r)if(o="[doc"+(r||"")+"]",!e.docs[o]){n=o;break}return e.addDoc(n,t)}function o(t,o){return"string"==typeof o?t.docs[o]:(o instanceof e&&(o=o.getDoc()),o instanceof e.Doc?n(t,o):void 0)}function i(e,t){e.server.request({files:[{type:"full",name:t.name,text:x(e,t)}]},function(e){e?window.console.error(e):t.changed=null})}function r(t,n,o){t.request(n,{type:"completions",types:!0,docs:!0,urls:!0},function(i,r){if(i)return y(t,n,i);var s=[],a="",c=r.start,l=r.end;'["'==n.getRange(b(c.line,c.ch-2),c)&&'"]'!=n.getRange(l,b(l.line,l.ch+2))&&(a='"]');for(var u=0;u<r.completions.length;++u){var f=r.completions[u],d=function(e){var t;t="?"==e?"unknown":"number"==e||"string"==e||"bool"==e?e:/^fn\(/.test(e)?"fn":/^\[/.test(e)?"array":"object";return w+"completion "+w+"completion-"+t}(f.type);r.guess&&(d+=" "+w+"guess"),s.push({text:f.name+a,displayText:f.displayName||f.name,className:d,data:f})}var p={from:c,to:l,list:s},h=null;e.on(p,"close",function(){v(h)}),e.on(p,"update",function(){v(h)}),e.on(p,"select",function(e,n){v(h);var o=t.options.completionTip?t.options.completionTip(e.data):e.data.doc;o&&((h=m(n.parentNode.getBoundingClientRect().right+window.pageXOffset,n.getBoundingClientRect().top+window.pageYOffset,o)).className+=" "+w+"hint-doc")}),o(p)})}function s(e,t,n,o,i){e.request(t,o,function(n,o){if(n)return y(e,t,n);if(e.options.typeTip)r=e.options.typeTip(o);else{var r=d("span",null,d("strong",null,o.type||"not found"));if(o.doc&&r.appendChild(document.createTextNode(" — "+o.doc)),o.url){r.appendChild(document.createTextNode(" "));var s=r.appendChild(d("a",null,"[docs]"));s.href=o.url,s.target="_blank"}}h(t,r,e),i&&i()},n)}function a(e,t,n){C(e);for(var o=e.cachedArgHints,i=o.type,r=d("span",o.guess?w+"fhint-guess":null,d("span",w+"fname",o.name),"("),s=0;s<i.args.length;++s){s&&r.appendChild(document.createTextNode(", "));var a=i.args[s];r.appendChild(d("span",w+"farg"+(s==n?" "+w+"farg-current":""),a.name||"?")),"?"!=a.type&&(r.appendChild(document.createTextNode(": ")),r.appendChild(d("span",w+"type",a.type)))}r.appendChild(document.createTextNode(i.rettype?") -> ":")")),i.rettype&&r.appendChild(d("span",w+"type",i.rettype));var c=t.cursorCoords(null,"page"),l=e.activeArgHints=m(c.right+1,c.bottom,r);setTimeout(function(){l.clear=g(t,function(){e.activeArgHints==l&&C(e)})},20)}function c(e,t){function o(o){var i={type:"definition",variable:o||null},r=n(e,t.getDoc());e.server.request(f(e,r,i),function(n,o){if(n)return y(e,t,n);if(o.file||!o.url){if(o.file){var i,s=e.docs[o.file];if(s&&(i=function(e,t){for(var n=t.context.slice(0,t.contextOffset).split("\n"),o=t.start.line-(n.length-1),i=b(o,(1==n.length?t.start.ch:e.getLine(o).length)-n[0].length),r=e.getLine(o).slice(i.ch),s=o+1;s<e.lineCount()&&r.length<t.context.length;++s)r+="\n"+e.getLine(s);if(r.slice(0,t.context.length)==t.context)return t;var a,c=e.getSearchCursor(t.context,0,!1),l=1/0;for(;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-i.line);f||(f=Math.abs(u.ch-i.ch)),f<l&&(a=u,l=f)}if(!a)return null;1==n.length?a.ch+=n[0].length:a=b(a.line+(n.length-1),n[n.length-1].length);if(t.start.line==t.end.line)d=b(a.line,a.ch+(t.end.ch-t.start.ch));else var d=b(a.line+(t.end.line-t.start.line),t.end.ch);return{start:a,end:d}}(s.doc,o)))return e.jumpStack.push({file:r.name,start:t.getCursor("from"),end:t.getCursor("to")}),void l(e,r,s,i.start,i.end)}y(e,t,"Could not find a definition.")}else window.open(o.url)})}!function(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return!(n.start<t.ch&&"comment"==n.type)&&/[\w)\]]/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}(t)?p(t,"Jump to variable",function(e){e&&o(e)}):o()}function l(e,t,n,o,i){n.doc.setSelection(o,i),t!=n&&e.options.switchToDoc&&(C(e),e.options.switchToDoc(n.name,n.doc))}function u(e,t){var n=t.getTokenAt(t.getCursor());if(!/\w/.test(n.string))return y(e,t,"Not at a variable");p(t,"New name for "+n.string,function(n){e.request(t,{type:"rename",newName:n,fullDocs:!0},function(n,o){if(n)return y(e,t,n);!function(e,t){for(var n=Object.create(null),o=0;o<t.length;++o){c=t[o];(n[c.file]||(n[c.file]=[])).push(c)}for(var i in n){var r=e.docs[i],s=n[i];if(r){s.sort(function(e,t){return D(t.start,e.start)});for(var a="*rename"+ ++k,o=0;o<s.length;++o){var c=s[o];r.doc.replaceRange(c.text,c.start,c.end,a)}}}}(e,o.changes)})})}function f(t,n,o,i){var r=[],s=0,a=!o.fullDocs;a||delete o.fullDocs,"string"==typeof o&&(o={type:o}),o.lineCharPositions=!0,null==o.end&&(o.end=i||n.doc.getCursor("end"),n.doc.somethingSelected()&&(o.start=n.doc.getCursor("start")));var c=o.start||o.end;if(n.changed)if(n.doc.lineCount()>T&&!1!==a&&n.changed.to-n.changed.from<100&&n.changed.from<=c.line&&n.changed.to>o.end.line){r.push(function(t,n,o){for(var i,r=t.doc,s=null,a=null,c=n.line-1,l=Math.max(0,c-50);c>=l;--c){var u=r.getLine(c);if(!(u.search(/\bfunction\b/)<0)){d=e.countColumn(u,null,4);null!=s&&s<=d||(s=d,a=c)}}null==a&&(a=l);var f=Math.min(r.lastLine(),o.line+20);if(null==s||s==e.countColumn(r.getLine(n.line),null,4))i=f;else for(i=o.line+1;i<f;++i){var d;if((d=e.countColumn(r.getLine(i),null,4))<=s)break}var p=b(a,0);return{type:"part",name:t.name,offsetLines:p.line,text:r.getRange(p,b(i,o.line==i?null:0))}}(n,c,o.end)),o.file="#0";s=r[0].offsetLines;null!=o.start&&(o.start=b(o.start.line- -s,o.start.ch)),o.end=b(o.end.line-s,o.end.ch)}else r.push({type:"full",name:n.name,text:x(t,n)}),o.file=n.name,n.changed=null;else o.file=n.name;for(var l in t.docs){var u=t.docs[l];u.changed&&u!=n&&(r.push({type:"full",name:u.name,text:x(t,u)}),u.changed=null)}return{query:o,files:r}}function d(e,t){var n=document.createElement(e);t&&(n.className=t);for(var o=2;o<arguments.length;++o){var i=arguments[o];"string"==typeof i&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function p(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function h(t,n,o){function i(){t.state.ternTooltip=null,s.parentNode&&function(e){e.style.opacity="0",setTimeout(function(){v(e)},1100)}(s),l()}t.state.ternTooltip&&v(t.state.ternTooltip);var r=t.cursorCoords(),s=t.state.ternTooltip=m(r.right+1,r.bottom,n),a=!1,c=!1;e.on(s,"mousemove",function(){a=!0}),e.on(s,"mouseout",function(t){e.contains(s,t.relatedTarget||t.toElement)||(c?i():a=!1)}),setTimeout(function(){c=!0,a||i()},o.options.hintDelay?o.options.hintDelay:1700);var l=g(t,i)}function g(e,t){return e.on("cursorActivity",t),e.on("blur",t),e.on("scroll",t),e.on("setDoc",t),function(){e.off("cursorActivity",t),e.off("blur",t),e.off("scroll",t),e.off("setDoc",t)}}function m(e,t,n){var o=d("div",w+"tooltip",n);return o.style.left=e+"px",o.style.top=t+"px",document.body.appendChild(o),o}function v(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function y(e,t,n){e.options.showError?e.options.showError(t,n):h(t,String(n),e)}function C(e){e.activeArgHints&&(e.activeArgHints.clear&&e.activeArgHints.clear(),v(e.activeArgHints),e.activeArgHints=null)}function x(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}e.TernServer=function(e){var o=this;this.options=e||{};var s=this.options.plugins||(this.options.plugins={});s.doc_comment||(s.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new function(e){function n(e,t){t&&(e.id=++i,r[i]=t),o.postMessage(e)}var o=e.worker=new Worker(e.options.workerScript);o.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var i=0,r={};o.onmessage=function(o){var i=o.data;"getFile"==i.type?t(e,i.name,function(e,t){n({type:"getFile",err:String(e),text:t,id:i.id})}):"debug"==i.type?window.console.log(i.message):i.id&&r[i.id]&&(r[i.id](i.err,i.body),delete r[i.id])},o.onerror=function(e){for(var t in r)r[t](e);r={}},this.addFile=function(e,t){n({type:"add",name:e,text:t})},this.delFile=function(e){n({type:"del",name:e})},this.request=function(e,t){n({type:"req",body:e},t)}}(this):this.server=new tern.Server({getFile:function(e,n){return t(o,e,n)},async:!0,defs:this.options.defs||[],plugins:s}),this.trackChange=function(e,t){!function(e,t,o){var r=n(e,t),s=e.cachedArgHints;s&&s.doc==t&&D(s.start,o.to)>=0&&(e.cachedArgHints=null);var a=r.changed;null==a&&(r.changed=a={from:o.from.line,to:o.from.line});var c=o.from.line+(o.text.length-1);o.from.line<a.to&&(a.to=a.to-(o.to.line-c)),c>=a.to&&(a.to=c+1),a.from>o.from.line&&(a.from=o.from.line),t.lineCount()>T&&o.to-a.from>100&&setTimeout(function(){r.changed&&r.changed.to-r.changed.from>100&&i(e,r)},200)}(o,e,t)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(e,t){return r(o,e,t)},this.getHint.async=!0},e.TernServer.prototype={addDoc:function(t,n){var o={doc:n,name:t,changed:null};return this.server.addFile(t,x(this,o)),e.on(n,"change",this.trackChange),this.docs[t]=o},delDoc:function(t){var n=o(this,t);n&&(e.off(n.doc,"change",this.trackChange),delete this.docs[n.name],this.server.delFile(n.name))},hideDoc:function(e){C(this);var t=o(this,e);t&&t.changed&&i(this,t)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){s(this,e,t,"type",n)},showDocs:function(e,t,n){s(this,e,t,"documentation",n)},updateArgHints:function(t){!function(t,n){if(C(t),!n.somethingSelected()){var o=n.getTokenAt(n.getCursor()).state,i=e.innerMode(n.getMode(),o);if("javascript"==i.mode.name){var r=i.state.lexical;if("call"==r.info){for(var s,c=r.pos||0,l=n.getOption("tabSize"),u=n.getCursor().line,f=Math.max(0,u-9),d=!1;u>=f;--u){for(var p=n.getLine(u),h=0,g=0;;){var m=p.indexOf("\t",g);if(-1==m)break;h+=l-(m+h)%l-1,g=m+1}if(s=r.column-h,"("==p.charAt(s)){d=!0;break}}if(d){var v=b(u,s),y=t.cachedArgHints;if(y&&y.doc==n.getDoc()&&0==D(v,y.start))return a(t,n,c);t.request(n,{type:"type",preferFunction:!0,end:v},function(e,o){!e&&o.type&&/^fn\(/.test(o.type)&&(t.cachedArgHints={start:v,type:function(e){function t(t){for(var n=0,i=o;;){var r=e.charAt(o);if(t.test(r)&&!n)return e.slice(i,o);/[{\[\(]/.test(r)?++n:/[}\]\)]/.test(r)&&--n,++o}}var n=[],o=3;if(")"!=e.charAt(o))for(;;){var i=e.slice(o).match(/^([^, \(\[\{]+): /);if(i&&(o+=i[0].length,i=i[1]),n.push({name:i,type:t(/[\),]/)}),")"==e.charAt(o))break;o+=2}var r=e.slice(o).match(/^\) -> (.*)$/);return{args:n,rettype:r&&r[1]}}(o.type),name:o.exprName||o.name||"fn",guess:o.guess,doc:n.getDoc()},a(t,n,c))})}}}}}(this,t)},jumpToDef:function(e){c(this,e)},jumpBack:function(e){!function(e,t){var o=e.jumpStack.pop(),i=o&&e.docs[o.file];i&&l(e,n(e,t.getDoc()),i,o.start,o.end)}(this,e)},rename:function(e){u(this,e)},selectName:function(e){!function(e,t){var o=n(e,t.doc).name;e.request(t,{type:"refs"},function(n,i){if(n)return y(e,t,n);for(var r=[],s=0,a=t.getCursor(),c=0;c<i.refs.length;c++){var l=i.refs[c];l.file==o&&(r.push({anchor:l.start,head:l.end}),D(a,l.start)>=0&&D(a,l.end)<=0&&(s=r.length-1))}t.setSelections(r,s)})}(this,e)},request:function(e,t,o,i){var r=this,s=n(this,e.getDoc()),a=f(this,s,t,i),c=a.query&&this.options.queryOptions&&this.options.queryOptions[a.query.type];if(c)for(var l in c)a.query[l]=c[l];this.server.request(a,function(e,n){!e&&r.options.responseFilter&&(n=r.options.responseFilter(s,t,a,e,n)),o(e,n)})},destroy:function(){C(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var b=e.Pos,w="CodeMirror-Tern-",T=250,k=0,D=e.cmpPos});