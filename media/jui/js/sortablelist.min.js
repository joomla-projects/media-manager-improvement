!function(a){a.JSortableList=function(b,c,d,e,f,g){var h=this;"desc"!=d&&(d="asc");var i=a.extend({orderingIcon:"add-on",orderingWrapper:"input-prepend",orderingGroup:"sortable-group-id",sortableClassName:"dndlist-sortable",placeHolderClassName:"dnd-list-highlight dndlist-place-holder",sortableHandle:".sortable-handler"},f);a("tr",b).removeClass(i.sortableClassName).addClass(i.sortableClassName),a(b).parents("table").css("position","relative"),a(i.sortableHandle,b).css("cursor","move"),a("#"+c).attr("autocomplete","off");var j=a(i.sortableHandle,a(b)).length>0?i.sortableHandle:"";a(b).sortable({axis:"y",cursor:"move",handle:j,items:"tr."+i.sortableClassName,placeholder:i.placeHolderClassName,helper:function(b,c){return a(c).css({left:"0px"}),c.children().each(function(){a(this).width(a(this).width())}),a(c).children("td").addClass("dndlist-dragged-row"),c},start:function(c,d){h.sortableGroupId=d.item.attr(i.orderingGroup),h.sortableGroupId?h.sortableRange=a("tr["+i.orderingGroup+"="+h.sortableGroupId+"]"):h.sortableRange=a("."+i.sortableClassName),h.disableOtherGroupSort(c,d),g&&(h.hideChildrenNodes(d.item.attr("item-id")),h.hideSameLevelChildrenNodes(d.item.attr("level")),a(b).sortable("refresh"))},stop:function(d,f){if(a("td",a(this)).removeClass("dndlist-dragged-row"),a(f.item).css({opacity:0}),a(f.item).animate({opacity:1},800,function(){a(f.item).css("opacity","")}),h.enableOtherGroupSort(d,f),h.rearrangeOrderingValues(h.sortableGroupId,f),e){h.cloneMarkedCheckboxes();var i=a("#"+c),j=a('input[name|="task"]',i);j.length&&j.detach(),a.post(e,i.serialize()),j.length&&j.appendTo(i),h.removeClonedCheckboxes()}h.disabledOrderingElements="",g&&(h.showChildrenNodes(f.item),h.showSameLevelChildrenNodes(f.item),a(b).sortable("refresh"))}}),this.hideChildrenNodes=function(a){h.childrenNodes=h.getChildrenNodes(a),h.childrenNodes.hide()},this.showChildrenNodes=function(a){a.after(h.childrenNodes),h.childrenNodes.show(),h.childrenNodes=""},this.hideSameLevelChildrenNodes=function(b){h.sameLevelNodes=h.getSameLevelNodes(b),h.sameLevelNodes.each(function(){_childrenNodes=h.getChildrenNodes(a(this).attr("item-id")),_childrenNodes.addClass("child-nodes-tmp-hide"),_childrenNodes.hide()})},this.showSameLevelChildrenNodes=function(b){prevItem=b.prev(),prevItemChildrenNodes=h.getChildrenNodes(prevItem.attr("item-id")),prevItem.after(prevItemChildrenNodes),a("tr.child-nodes-tmp-hide").show().removeClass("child-nodes-tmp-hide"),h.sameLevelNodes=""},this.disableOtherGroupSort=function(c,d){if(h.sortableGroupId){a("tr["+i.orderingGroup+"!="+h.sortableGroupId+"]",a(b)).removeClass(i.sortableClassName).addClass("dndlist-group-disabled"),a(b).sortable("refresh")}},this.enableOtherGroupSort=function(c,d){a("tr",a(b)).removeClass(i.sortableClassName).addClass(i.sortableClassName).removeClass("dndlist-group-disabled"),a(b).sortable("refresh")},this.disableOrderingControl=function(){a("."+i.orderingWrapper+" .add-on a",h.sortableRange).hide()},this.enableOrderingControl=function(){a("."+i.orderingWrapper+" .add-on a",h.disabledOrderingElements).show()},this.rearrangeOrderingControl=function(b,c){var d;h.sortableRange=a(b?"tr["+i.orderingGroup+"="+b+"]":"."+i.sortableClassName),d=h.sortableRange;var e=d.length;e>1&&(d.each(function(){var b=a("."+i.orderingWrapper+" .add-on:first a",a(this)),c=a("."+i.orderingWrapper+" .add-on:last a",a(this));b.get(0)&&c.get(0)||(b.get(0)?(b.removeAttr("title"),b=a("."+i.orderingWrapper+" .add-on:first",a(this)).html(),c=b.replace("icon-uparrow","icon-downarrow"),c=c.replace(".orderup",".orderdown"),a("."+i.orderingWrapper+" .add-on:last",a(this)).html(c)):c.get(0)&&(c.removeAttr("title"),c=a("."+i.orderingWrapper+" .add-on:last",a(this)).html(),b=c.replace("icon-downarrow","icon-uparrow"),b=b.replace(".orderdown",".orderup"),a("."+i.orderingWrapper+" .add-on:first",a(this)).html(b)))}),a("."+i.orderingWrapper+" .add-on:first a",d[0]).remove(),a("."+i.orderingWrapper+" .add-on:last a",d[e-1]).remove())},this.rearrangeOrderingValues=function(b,c){var e;h.sortableRange=a(b?"tr["+i.orderingGroup+"="+b+"]":"."+i.sortableClassName),e=h.sortableRange;var f=e.length;f>1&&(c.originalPosition.top>c.position.top?(c.item.position().top!=c.originalPosition.top&&a('[name="order[]"]',c.item).attr("value",parseInt(a("[type=text]",c.item.next()).attr("value"))),a(e).each(function(){var b=a(this).position().top;if(c.item.get(0)!==a(this).get(0)&&b>c.item.position().top&&b<c.originalPosition.top+c.item.outerHeight()){if("asc"==d)var e=parseInt(a('[name="order[]"]',a(this)).attr("value"))+1;else var e=parseInt(a('[name="order[]"]',a(this)).attr("value"))-1;a('[name="order[]"]',a(this)).attr("value",e)}})):c.originalPosition.top<c.position.top&&(c.item.position().top!=c.originalPosition.top&&a('[name="order[]"]',c.item).attr("value",parseInt(a('[name="order[]"]',c.item.prev()).attr("value"))),a(e).each(function(){var b=a(this).position().top;if(c.item.get(0)!==a(this).get(0)&&b<c.item.position().top&&b>=c.originalPosition.top){if("asc"==d)var e=parseInt(a('[name="order[]"]',a(this)).attr("value"))-1;else var e=parseInt(a('[name="order[]"]',a(this)).attr("value"))+1;a('[name="order[]"]',a(this)).attr("value",e)}})))},this.cloneMarkedCheckboxes=function(){a('[name="order[]"]',a(b)).attr("name","order-tmp"),a("[type=checkbox]",h.sortableRange).each(function(){var b=a(this).clone();a(b).attr({checked:"checked",shadow:"shadow",id:""}),a("#"+c).append(a(b)),a('[name="order-tmp"]',a(this).parents("tr")).attr("name","order[]")})},this.removeClonedCheckboxes=function(){a("[shadow=shadow]").remove(),a('[name="order-tmp"]',a(b)).attr("name","order[]")},this.getChildrenNodes=function(b){return a('tr[parents~="'+b+'"]')},this.getSameLevelNodes=function(b){return a("tr[level="+b+"]")}}}(jQuery);